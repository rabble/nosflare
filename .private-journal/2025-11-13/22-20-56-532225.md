---
title: "10:20:56 PM - November 13, 2025"
date: 2025-11-13T22:20:56.532Z
timestamp: 1763072456532
---

## Project Notes

nosflare relay performance fix:

Root cause: Lines 798-828 in relay-worker.ts were doing synchronous FTS5 indexing (DELETE + INSERT) for every event, plus looping through hashtags. With 8k users/hour this created severe write contention.

Changes made:
1. Added Queue binding to wrangler.toml (search-indexing-queue + DLQ)
2. Updated types.ts with SearchIndexMessage interface and Queue binding
3. Created queue consumer in relay-worker.ts default export
4. Modified saveEventToD1 to send queue messages instead of direct indexing
5. Created queues: search-indexing-queue and search-indexing-dlq

Files modified:
- wrangler.toml (queue config)
- src/types.ts (SearchIndexMessage, Env)
- src/relay-worker.ts (queue consumer, saveEventToD1)

Trade-off: Search index now lags by a few seconds but writes are fast.

