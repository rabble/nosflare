---
title: "8:59:28 AM - October 31, 2025"
date: 2025-10-30T19:59:28.640Z
timestamp: 1761854368640
---

## Project Notes

**Staging Environment Architecture for nosflare Relay**

Recommended approach for Cloudflare Workers multi-environment setup:

**Key Decision: Use Wrangler Environments (not separate workers)**
- Single wrangler.toml with [env.staging] section
- Automatic worker naming: nosflare (prod), nosflare-staging (staging)
- Deploy commands: `wrangler deploy` vs `wrangler deploy --env staging`
- Native support for environment-specific secrets and bindings

**Infrastructure:**
- Separate D1 database: nostr-relay-staging (complete isolation)
- Separate R2 bucket: nostr-event-archive-staging
- Domain: staging.relay.divine.video
- Durable Objects: Automatically isolated per environment

**Configuration Pattern:**
- Environment variables in wrangler.toml: ENVIRONMENT, RELAY_DOMAIN
- src/config.ts: Add getRelayInfo(env) function for environment-aware config
- Relay info automatically shows "STAGING" indicator and different contact email

**Database Strategy:**
- Start with fresh staging database (no production data copy)
- Migrations run automatically via existing migrations.ts system
- Test in staging before production promotion
- Separate cleanup workers for each environment

**Testing Pattern:**
- Update test scripts to accept environment parameter: `node test-*.cjs staging`
- Package.json scripts: npm run test:staging, npm run deploy:staging
- Test runner script to validate all tests against staging before prod deploy

**Critical Gotchas:**
1. Each environment needs separate D1 database ID in wrangler.toml
2. Durable Objects are automatically isolated (no shared state)
3. Secrets must be set per environment: `wrangler secret put X --env staging`
4. Domain routes need to be added after first deployment
5. Both environments share account CPU quota

**Deployment Workflow:**
1. Deploy to staging: npm run deploy:staging
2. Run tests: npm run test:all:staging  
3. Verify migrations and logs
4. Deploy to prod: npm run deploy
5. Rollback if needed: wrangler rollback [deployment-id]

**Files to Update:**
- wrangler.toml: Add [env.staging] section with database bindings
- src/config.ts: Add getRelayInfo(env) function
- package.json: Add staging-specific scripts
- All test-*.cjs files: Accept environment parameter
- New files: seed-staging.cjs, cleanup-staging.sh, run-all-tests.sh

This pattern scales well and follows Cloudflare best practices for multi-environment Workers projects.
