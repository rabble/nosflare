# Change name if you feel like it
name = "nosflare"
compatibility_date = "2025-01-04"
main = "worker.js"

# Durable Objects bindings
[[durable_objects.bindings]]
name = "RELAY_WEBSOCKET"
class_name = "RelayWebSocket"

[[durable_objects.bindings]]
name = "METRICS_DO"
class_name = "MetricsDO"

# D1 Database binding
# Important! Change name and id settings to your own
[[d1_databases]]
binding = "RELAY_DATABASE"
database_name = "nostr-relay"
database_id = "8beb11fa-ff53-462e-82a4-64a8a7db68a2"

# R2 bucket binding for event archive
[[r2_buckets]]
binding = "EVENT_ARCHIVE"
bucket_name = "nostr-event-archive"

# Queue binding for async FTS5 indexing
[[queues.producers]]
queue = "search-indexing-queue"
binding = "SEARCH_INDEX_QUEUE"

[[queues.consumers]]
queue = "search-indexing-queue"
max_batch_size = 100
max_batch_timeout = 30
max_retries = 3
max_concurrency = 5
dead_letter_queue = "search-indexing-dlq"

# CPU limits (lower to 10 if not on paid Workers plan)
[limits]
cpu_ms = 30000

# Enable logs (on by default, but can disable)
[observability.logs]
enabled = true

# Durable Object migrations with SQLite storage backend
[[migrations]]
tag = "v3"
new_sqlite_classes = ["RelayWebSocket"]

[[migrations]]
tag = "v4"
new_sqlite_classes = ["MetricsDO"]

# Scheduled worker for archiving
[triggers]
crons = ["*/30 * * * *"]  # Run every 30 min

# Production environment variables
[vars]
ENVIRONMENT = "production"
RELAY_DOMAIN = "relay.divine.video"

# ============================================
# STAGING ENVIRONMENT
# ============================================
[env.staging]
name = "nosflare-staging"

# Staging D1 Database binding
[[env.staging.d1_databases]]
binding = "RELAY_DATABASE"
database_name = "nostr-relay-staging"
database_id = "c345a4fe-26ce-4056-a70b-0085bc3448e1"

# Staging R2 bucket binding
# TODO: Create bucket via dashboard
# Command: Go to Cloudflare Dashboard → R2
#          Click "Create bucket" → Name: nostr-event-archive-staging
[[env.staging.r2_buckets]]
binding = "EVENT_ARCHIVE"
bucket_name = "nostr-event-archive-staging"

# Staging environment variables
[env.staging.vars]
ENVIRONMENT = "staging"
RELAY_DOMAIN = "staging-relay.divine.video"

# Run archival less frequently in staging (every 2 hours)
[env.staging.triggers]
crons = ["0 */2 * * *"]